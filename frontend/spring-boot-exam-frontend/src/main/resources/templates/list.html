<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>mbc board (front)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5">
    <h2 class="mb-4">게시판 목록</h2>

    <!-- 검색 + 글쓰기 -->
    <div class="row justify-content-between align-items-center mb-3 gx-3">
        <div class="col-auto flex-grow-1">
            <form id="searchForm">
                <div class="row row-cols-auto g-2 align-items-center">
                    <div class="col">
                        <select id="scope" class="form-select form-select-sm">
                            <option value="tcw">전체</option>
                            <option value="t">제목</option>
                            <option value="c">내용</option>
                            <option value="w">작성자</option>
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" id="search" class="form-control form-control-sm" placeholder="검색어 입력" />
                    </div>
                    <div class="col">
                        <button type="submit" class="btn btn-sm btn-outline-primary">검색</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-auto">
            <a href="/board/register" class="btn btn-sm btn-primary">글쓰기</a>
        </div>
    </div>

    <!-- 목록 -->
    <table class="table table-hover table-bordered align-middle text-center">
        <thead class="table-light">
        <tr class="row g-0">
            <th class="col-1">no</th>
            <th class="col-5">제목</th>
            <th class="col-2">작성자</th>
            <th class="col-2">작성일</th>
            <th class="col-2">조회수</th>
        </tr>
        </thead>
        <tbody id="listBody"></tbody>
    </table>

    <!-- 페이징 -->
    <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>

<!-- Script -->
<script>
    const queryParams = new URLSearchParams(window.location.search);
    let page   = parseInt(queryParams.get("page")) || 1;
    let scope  = queryParams.get("scope") || "tcw";
    let search = queryParams.get("search") || "";

    document.getElementById("scope").value = scope;
    document.getElementById("search").value = search;

    document.getElementById("searchForm").addEventListener("submit", e => {
        e.preventDefault();
        scope  = document.getElementById("scope").value;
        search = document.getElementById("search").value;
        location.href = `/board/list?page=1&scope=${scope}&search=${encodeURIComponent(search)}`;
    });

    function formatDate(dateString) {
        const date  = new Date(dateString);
        const today = new Date();
        const isToday = date.getFullYear() === today.getFullYear() &&
            date.getMonth() === today.getMonth() &&
            date.getDate() === today.getDate();
        if (isToday) {
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        } else {
            const yyyy = date.getFullYear();
            const mm   = String(date.getMonth() + 1).padStart(2, '0');
            const dd   = String(date.getDate()).padStart(2, '0');
            return `${yyyy}.${mm}.${dd}.`;
        }
    }

    function loadPage(pageNum) {
        const apiUrl = new URL("http://192.168.0.171:6805/api/board/boards");
        apiUrl.searchParams.append("page", pageNum);
        if (search.trim()) {
            apiUrl.searchParams.append("scope", scope);
            apiUrl.searchParams.append("search", search);
        }

        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
                renderList(data.result.contents);
                renderPagination(data.result);
            });
    }

    function renderList(list) {
        const tbody = document.getElementById("listBody");
        tbody.innerHTML = "";

        list.forEach(row => {
            const tr = document.createElement("tr");
            tr.classList.add("row", "g-0");

            const titleCell = row.deletedYn === "Y"
                ? `<span class="text-secondary">삭제된 게시물입니다.</span>`
                : `<a href="/board/read?boardIndex=${row.boardIndex}">${row.title}</a>`;

            tr.innerHTML = `
        <td class="col-1">${row.boardIndex}</td>
        <td class="col-5 text-start">${titleCell}</td>
        <td class="col-2">${row.writerId}</td>
        <td class="col-2">${formatDate(row.createDate)}</td>
        <td class="col-2">${row.viewCount}</td>`;
            tbody.appendChild(tr);
        });
    }

    function renderPagination(paging) {
        const { pageNum, totalPageCnt } = paging;
        const currentPage  = pageNum + 1;
        const totalPages   = totalPageCnt;
        const blockSize    = 10;
        const currentBlock = Math.floor((currentPage - 1) / blockSize);
        const blockStart   = currentBlock * blockSize + 1;
        const blockEnd     = Math.min(blockStart + blockSize - 1, totalPages);

        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (currentPage > 1) {
            pagination.innerHTML += `
        <li class="page-item">
          <a class="page-link" href="javascript:goPage(1)">⏮</a>
        </li>`;
        }

        if (blockStart > 1) {
            pagination.innerHTML += `
        <li class="page-item">
          <a class="page-link" href="javascript:goPage(${blockStart - 1})">«</a>
        </li>`;
        }

        for (let i = blockStart; i <= blockEnd; i++) {
            pagination.innerHTML += `
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="javascript:goPage(${i})">${i}</a>
        </li>`;
        }

        if (blockEnd < totalPages) {
            pagination.innerHTML += `
        <li class="page-item">
          <a class="page-link" href="javascript:goPage(${blockEnd + 1})">»</a>
        </li>`;
        }

        if (currentPage < totalPages) {
            pagination.innerHTML += `
        <li class="page-item">
          <a class="page-link" href="javascript:goPage(${totalPages})">⏭</a>
        </li>`;
        }
    }

    function goPage(p) {
        const params = new URLSearchParams();
        params.append("page", p);
        if (search.trim()) {
            params.append("scope", scope);
            params.append("search", search);
        }
        location.href = "/board/list?" + params.toString();
    }

    loadPage(page);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
